<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Inventory">
    <title>Inventory</title>
    
    <!-- Favicon (Dynamic) -->
    <link rel="icon" id="favicon-link">

    <!-- PWA Manifest (Inline) -->
    <link rel="manifest" id="manifest-placeholder">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Chart.js for Dashboard -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    
    <!-- PapaParse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Globally disable tap highlight */
        * { -webkit-tap-highlight-color: transparent; }
        
        .scroller { -webkit-overflow-scrolling: touch; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Sidebar Active State */
        .nav-item-active { background-color: #eff6ff; color: #2563eb; border-right: 3px solid #2563eb; }
        .nav-item-inactive { color: #64748b; }
        .nav-item-inactive:hover { background-color: #f8fafc; color: #1e293b; }

        /* Mobile Bottom Nav Active State */
        .mobile-nav-active { color: #2563eb; font-weight: 600; }
        .mobile-nav-inactive { color: #94a3b8; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #e5e7eb; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #d1d5db; }
        
        /* Toast Animation */
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast-enter { animation: slideIn 0.3s ease-out forwards; }

        /* Prevent pull-to-refresh on mobile */
        body { overscroll-behavior-y: none; }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        /* Auth Screen Background */
        .auth-bg {
            background-color: #f8fafc;
            background-image: radial-gradient(#e2e8f0 1px, transparent 1px);
            background-size: 24px 24px;
        }
        
        /* Mobile Input Text Size Fix (Prevents Zoom) */
        @media screen and (max-width: 768px) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen flex overflow-hidden">

    <!-- Auth Container (Login Screen) -->
    <div id="auth-container" class="fixed inset-0 z-50 flex flex-col items-center justify-center p-6 auth-bg hidden">
        <!-- Content injected by JS -->
    </div>

    <!-- Sidebar (Desktop Only) -->
    <aside id="app-sidebar" class="hidden md:flex w-64 bg-white border-r border-gray-200 flex-col flex-none z-30 transition-all duration-300">
        <div class="h-16 flex items-center justify-start px-6 border-b border-gray-100 flex-none">
            <div class="bg-blue-600 p-1.5 rounded-lg">
                <i data-lucide="package" class="w-6 h-6 text-white"></i>
            </div>
            <span class="ml-3 font-bold text-lg text-gray-800 tracking-tight">Inventory</span>
        </div>

        <nav class="flex-1 py-6 flex flex-col gap-2 px-4 overflow-y-auto scroller">
            <button onclick="app.setActiveTab('dashboard')" id="nav-dashboard" class="nav-btn group flex items-center justify-start px-3 py-3 rounded-lg transition-all">
                <i data-lucide="layout-dashboard" class="w-6 h-6 flex-none"></i>
                <span class="ml-3 font-medium text-sm">Dashboard</span>
            </button>
            <div class="my-1 border-t border-gray-100"></div>
            <button onclick="app.setActiveTab('storage')" id="nav-storage" class="nav-btn group flex items-center justify-start px-3 py-3 rounded-lg transition-all">
                <i data-lucide="package" class="w-6 h-6 flex-none"></i>
                <span class="ml-3 font-medium text-sm">Storage</span>
            </button>
            <button onclick="app.setActiveTab('floors')" id="nav-floors" class="nav-btn group flex items-center justify-start px-3 py-3 rounded-lg transition-all">
                <i data-lucide="layers" class="w-6 h-6 flex-none"></i>
                <span class="ml-3 font-medium text-sm">Floors</span>
            </button>
            <button onclick="app.setActiveTab('boxes')" id="nav-boxes" class="nav-btn group flex items-center justify-start px-3 py-3 rounded-lg transition-all">
                <i data-lucide="box" class="w-6 h-6 flex-none"></i>
                <span class="ml-3 font-medium text-sm">Boxes</span>
            </button>
            <div class="my-2 border-t border-gray-100"></div>
            <button onclick="app.setActiveTab('activity')" id="nav-activity" class="nav-btn group flex items-center justify-start px-3 py-3 rounded-lg transition-all">
                <i data-lucide="clipboard-list" class="w-6 h-6 flex-none"></i>
                <span class="ml-3 font-medium text-sm">Activity Log</span>
            </button>
        </nav>
        
        <!-- Settings Footer (Desktop) -->
        <div id="sidebar-settings-container" class="p-4 border-t border-gray-100">
             <button onclick="app.setActiveTab('settings')" id="nav-settings" class="w-full nav-btn group flex items-center justify-start px-3 py-3 rounded-lg transition-all hover:bg-gray-50 text-gray-500 hover:text-gray-900">
                <i data-lucide="settings" class="w-6 h-6 flex-none"></i>
                <span class="ml-3 font-medium text-sm">Settings</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <div id="app-main" class="flex-1 flex flex-col min-w-0 bg-gray-50 h-full relative hidden">
        <!-- Header -->
        <header class="bg-white border-b border-gray-200 h-16 px-4 md:px-8 flex items-center justify-between shadow-sm z-20 flex-none sticky top-0">
            <div class="flex items-center">
                <div class="md:hidden bg-blue-600 p-1.5 rounded-lg mr-3">
                    <i data-lucide="package" class="w-5 h-5 text-white"></i>
                </div>
                <div>
                    <h1 id="header-title" class="text-lg md:text-xl font-bold text-gray-800">Overview</h1>
                    <p id="header-subtitle" class="text-xs text-gray-500 hidden sm:block">Manage your equipment inventory and locations</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2 md:gap-4">
                <!-- Live Indicator (Visible on Tablet/Desktop) -->
                <span class="hidden sm:flex text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full border border-green-200 font-medium items-center gap-1">
                    <div class="w-1.5 h-1.5 rounded-full bg-green-500"></div> <span>Live</span>
                </span>
                
                <!-- User Menu -->
                <div class="relative">
                    <button id="user-menu-btn" onclick="event.stopPropagation(); app.toggleUserMenu()" class="flex items-center gap-2 focus:outline-none hover:bg-gray-50 p-1.5 rounded-lg transition">
                        <div class="text-right hidden md:block">
                            <p id="header-user-name" class="text-xs font-bold text-gray-700 leading-none">User</p>
                            <p id="header-user-role" class="text-[10px] text-gray-400 leading-none mt-1">Loading...</p>
                        </div>
                        <div class="bg-blue-100 text-blue-600 p-2 rounded-full border border-blue-200 shadow-sm">
                            <i data-lucide="user" class="w-5 h-5"></i>
                        </div>
                    </button>
                    
                    <!-- Dropdown -->
                    <div id="user-menu-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-xl shadow-xl border border-gray-100 z-50 transform origin-top-right transition-all">
                        <!-- Mobile User Info inside Dropdown -->
                        <div class="p-4 border-b border-gray-100 md:hidden bg-gray-50 rounded-t-xl">
                            <p class="text-xs text-gray-400 font-bold uppercase tracking-wider mb-1">Signed in as</p>
                            <p id="header-user-name-mobile" class="text-sm font-bold text-gray-800 truncate">User</p>
                            <p id="header-user-role-mobile" class="text-xs text-gray-500 truncate">Role</p>
                        </div>
                        
                        <div class="p-2 space-y-1">
                            <button onclick="app.openEditProfileModal(); app.toggleUserMenu()" class="w-full text-left flex items-center gap-3 px-3 py-2.5 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 rounded-lg transition font-medium">
                                <i data-lucide="user-cog" class="w-4 h-4"></i> Edit Profile
                            </button>
                            <div class="border-t border-gray-100 my-1"></div>
                            <button onclick="app.handleLogout()" class="w-full text-left flex items-center gap-3 px-3 py-2.5 text-sm text-red-600 hover:bg-red-50 rounded-lg transition font-medium">
                                <i data-lucide="log-out" class="w-4 h-4"></i> Log Out
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Scrollable Content -->
        <main id="main-content" class="flex-1 overflow-y-auto p-4 md:p-8 scroller pb-24 md:pb-8">
            <div id="loading-state" class="flex h-full items-center justify-center text-gray-500">
                <div class="animate-spin mr-2"><i data-lucide="loader-2"></i></div>
                Loading data...
            </div>
        </main>

        <!-- Mobile Bottom Navigation (Visible on Small Screens) -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 flex justify-between px-2 pb-safe pt-2 z-30 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <button onclick="app.setActiveTab('dashboard')" id="mob-dashboard" class="flex-1 flex flex-col items-center p-2 mobile-nav-inactive">
                <i data-lucide="layout-dashboard" class="w-5 h-5 mb-1"></i>
                <span class="text-[9px] font-medium">Home</span>
            </button>
            <button onclick="app.setActiveTab('storage')" id="mob-storage" class="flex-1 flex flex-col items-center p-2 mobile-nav-inactive">
                <i data-lucide="package" class="w-5 h-5 mb-1"></i>
                <span class="text-[9px] font-medium">Items</span>
            </button>
            <button onclick="app.setActiveTab('floors')" id="mob-floors" class="flex-1 flex flex-col items-center p-2 mobile-nav-inactive">
                <i data-lucide="layers" class="w-5 h-5 mb-1"></i>
                <span class="text-[9px] font-medium">Floors</span>
            </button>
            <button onclick="app.setActiveTab('boxes')" id="mob-boxes" class="flex-1 flex flex-col items-center p-2 mobile-nav-inactive">
                <i data-lucide="box" class="w-5 h-5 mb-1"></i>
                <span class="text-[9px] font-medium">Boxes</span>
            </button>
            <button onclick="app.setActiveTab('activity')" id="mob-activity" class="flex-1 flex flex-col items-center p-2 mobile-nav-inactive">
                <i data-lucide="clipboard-list" class="w-5 h-5 mb-1"></i>
                <span class="text-[9px] font-medium">Logs</span>
            </button>
            <button onclick="app.setActiveTab('settings')" id="mob-settings" class="flex-1 flex flex-col items-center p-2 mobile-nav-inactive">
                <i data-lucide="menu" class="w-6 h-6 mb-1"></i>
                <span class="text-[9px] font-medium">More</span>
            </button>
        </nav>
    </div>

    <!-- Modals -->
    <div id="modal-container" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity" onclick="app.closeModal()"></div>
        <div id="modal-content" class="relative z-10 w-full h-full flex items-center justify-center p-4 pointer-events-none"></div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="app.closeConfirmModal()"></div>
        <div class="bg-white rounded-xl shadow-2xl p-6 relative w-full max-w-sm transform transition-all scale-100">
            <h3 class="text-lg font-bold text-gray-800 mb-2">Confirm Action</h3>
            <p id="confirm-message" class="text-gray-600 mb-6 text-sm">Are you sure you want to proceed?</p>
            <div class="flex gap-3 justify-end">
                <button onclick="app.closeConfirmModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg text-sm font-medium transition">Cancel</button>
                <button onclick="app.executePendingAction()" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 shadow-lg transition">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Hidden Input for File Upload -->
    <input type="file" id="csv-upload" accept=".csv" class="hidden" onchange="app.handleFileUpload(event)">

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-[70] flex flex-col gap-2 pointer-events-none"></div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, updateProfile, sendPasswordResetEmail, updateEmail, updatePassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, getDoc, updateDoc, deleteDoc, onSnapshot, query, setDoc, getDoc as getDocFire, writeBatch, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- ICON GENERATION ---
        const appIconSvg = `
        <svg xmlns="http://www.w3.org/2000/svg" width="512" height="512" viewBox="0 0 512 512">
            <rect width="512" height="512" rx="100" fill="#2563eb"/>
            <path d="M256 120 L100 200 L100 380 L256 460 L412 380 L412 200 Z" fill="none" stroke="white" stroke-width="32" stroke-linejoin="round" stroke-linecap="round"/>
            <path d="M100 200 L256 280 L412 200" fill="none" stroke="white" stroke-width="32" stroke-linejoin="round" stroke-linecap="round"/>
            <path d="M256 460 L256 280" fill="none" stroke="white" stroke-width="32" stroke-linejoin="round" stroke-linecap="round"/>
            <line x1="200" y1="250" x2="312" y2="250" stroke="white" stroke-width="32" stroke-linecap="round"/>
        </svg>`;
        const appIconUrl = 'data:image/svg+xml;base64,' + btoa(appIconSvg);
        document.getElementById('favicon-link').href = appIconUrl;

        // --- FIREBASE CONFIGURATION ---
        // ⚠️ IMPORTANT: REPLACE THIS WITH YOUR OWN FIREBASE PROJECT CONFIGURATION
        // 1. Go to console.firebase.google.com
        // 2. Create a project
        // 3. Add a Web App
        // 4. Copy the config below
        // 5. Enable Authentication > Sign-in method > Email/Password
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyAOB5sXGQPdchw3jhWojfy749cOTeAcfyw",
  authDomain: "inventory-app-84fbf.firebaseapp.com",
  projectId: "inventory-app-84fbf",
  storageBucket: "inventory-app-84fbf.firebasestorage.app",
  messagingSenderId: "120713547404",
  appId: "1:120713547404:web:d092abf67d26a33351b5a9",
  measurementId: "G-3KLSG5BE43"
};

        let firebaseConfig = customConfig;
        if (typeof __firebase_config !== 'undefined') firebaseConfig = JSON.parse(__firebase_config);

        const appInstance = initializeApp(firebaseConfig);
        const auth = getAuth(appInstance);
        const db = getFirestore(appInstance);
        const appId = customConfig.appId ? 'inventory-app-84fbf' : (typeof __app_id !== 'undefined' ? __app_id : 'default-app-id');

        const state = {
            user: null,
            userRole: null,
            authMode: 'login',
            loginAttempts: 0,
            inventory: [],
            locations: [],
            logs: [],
            masterData: { categories: [], retiredIds: [] }, 
            activeTab: 'dashboard', 
            storageViewMode: 'active', 
            settingsTab: 'categories',
            currentModal: null, 
            pendingAction: null,
            loading: true,
            loadingAuth: false,
            searchTerm: ''
        };

        window.esc = (str) => typeof str !== 'string' ? str : str.replace(/'/g, "\\'").replace(/"/g, '&quot;');

        function formatDatePH(isoString) {
            if (!isoString) return '';
            try { return new Date(isoString).toLocaleString('en-US', { timeZone: 'Asia/Manila', year: 'numeric', month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit', hour12: true }); } 
            catch (e) { return new Date(isoString).toLocaleString(); }
        }

        // --- VIEW GENERATORS (Moved here to ensure availability) ---
        function generateAuthView() {
            const isLogin = state.authMode === 'login';
            const isForgot = state.authMode === 'forgot';
            const isLoading = state.loadingAuth;

            if (isForgot) {
                return `<div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-xl border border-gray-100 animate-in mx-4"><div class="text-center mb-8"><div class="inline-block p-3 bg-red-100 rounded-xl shadow-lg shadow-red-50 mb-4"><i data-lucide="key-round" class="w-8 h-8 text-red-600"></i></div><h1 class="text-2xl font-bold text-gray-900 tracking-tight">Reset Password</h1><p class="text-sm text-gray-500 mt-2">Enter your email to receive reset instructions</p></div><form onsubmit="app.handleForgotPassword(event)" class="space-y-5"><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 tracking-wider">Email Address</label><div class="relative"><i data-lucide="mail" class="absolute left-3 top-3.5 text-gray-400 w-5 h-5"></i><input type="email" name="email" required placeholder="name@company.com" class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition"></div></div><button type="submit" class="w-full py-3.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 transition transform active:scale-[0.99] flex justify-center items-center gap-2" ${isLoading ? 'disabled' : ''}>${isLoading ? 'Sending...' : 'Send Reset Link'}</button></form><div class="mt-6 text-center"><button onclick="app.setAuthMode('login')" class="text-sm text-gray-500 hover:text-blue-600 font-medium transition">Back to Sign In</button></div></div>`;
            }

            return `<div class="bg-white w-full max-w-md p-8 rounded-2xl shadow-xl border border-gray-100 animate-in mx-4"><div class="text-center mb-8"><div class="inline-block p-3 bg-blue-600 rounded-xl shadow-lg shadow-blue-200 mb-4"><i data-lucide="package" class="w-8 h-8 text-white"></i></div><h1 class="text-2xl font-bold text-gray-900 tracking-tight">Inventory Manager</h1><p class="text-sm text-gray-500 mt-2">Please sign in to access the system</p></div><form onsubmit="${isLogin ? 'app.handleLogin(event)' : 'app.handleRegister(event)'}" class="space-y-5">${!isLogin ? `<div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 tracking-wider">Nickname</label><div class="relative"><i data-lucide="user" class="absolute left-3 top-3.5 text-gray-400 w-5 h-5"></i><input type="text" name="nickname" required placeholder="John Doe" class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition"></div></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 tracking-wider">Role</label><div class="relative"><i data-lucide="shield" class="absolute left-3 top-3.5 text-gray-400 w-5 h-5"></i><select name="role" required class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition appearance-none"><option value="" disabled selected>Select Role...</option><option value="Live Operator">Live Operator</option><option value="Technical Support Supervisor">Technical Support Supervisor</option><option value="Live Operator Lead">Live Operator Lead</option><option value="Live Operator Trainer">Live Operator Trainer</option></select><i data-lucide="chevron-down" class="absolute right-3 top-3.5 text-gray-400 w-4 h-4 pointer-events-none"></i></div></div>` : ''}<div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 tracking-wider">Email Address</label><div class="relative"><i data-lucide="mail" class="absolute left-3 top-3.5 text-gray-400 w-5 h-5"></i><input type="email" name="email" required placeholder="name@company.com" class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition"></div></div><div><label class="block text-xs font-bold text-gray-500 uppercase mb-1 tracking-wider">Password</label><div class="relative"><i data-lucide="lock" class="absolute left-3 top-3.5 text-gray-400 w-5 h-5"></i><input type="password" name="password" required minlength="6" placeholder="••••••••" class="w-full pl-10 pr-4 py-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:bg-white outline-none transition"></div></div>${isLogin && state.loginAttempts >= 3 ? `<div class="p-3 bg-red-50 border border-red-100 rounded-lg flex items-center justify-between animate-in"><span class="text-xs text-red-600 font-medium">Trouble logging in?</span><button type="button" onclick="app.setAuthMode('forgot')" class="text-xs font-bold text-red-700 hover:underline">Reset Password</button></div>` : ''}<button type="submit" class="w-full py-3.5 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-xl shadow-lg shadow-blue-200 transition transform active:scale-[0.99] flex justify-center items-center gap-2" ${isLoading ? 'disabled' : ''}>${isLoading ? 'Processing...' : (isLogin ? 'Sign In' : 'Create Account')} <i data-lucide="arrow-right" class="w-4 h-4"></i></button></form><div class="mt-6 text-center space-y-2"><button onclick="app.toggleAuthMode()" class="block w-full text-sm text-gray-500 hover:text-blue-600 font-medium transition">${isLogin ? "Don't have an account? Create one" : "Already have an account? Sign In"}</button>${isLogin && state.loginAttempts < 3 ? `<button onclick="app.setAuthMode('forgot')" class="block w-full text-xs text-gray-400 hover:text-gray-600 transition">Forgot Password?</button>` : ''}</div></div>`;
        }

        function generateDashboardView() {
            const totalItems = state.inventory.filter(i => !i.isDisposed).length;
            const disposedItems = state.inventory.filter(i => i.isDisposed).length;
            const assignedItems = state.inventory.filter(i => !i.isDisposed && i.locationId).length;
            const unassignedItems = totalItems - assignedItems;
            
            const subCategories = {};
            state.inventory.filter(i => !i.isDisposed).forEach(i => {
                const sub = i.subCategory || 'General';
                subCategories[sub] = (subCategories[sub] || 0) + 1;
            });
            
            const rooms = state.locations.filter(l => l.type === 'room');
            const occupiedRooms = rooms.filter(r => r.status === 'occupied').length;
            const vacantRooms = rooms.filter(r => r.status === 'vacant').length;
            const maintenanceRooms = rooms.filter(r => r.status === 'maintenance').length;

            return `
            <div class="space-y-6 fade-in max-w-7xl mx-auto">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-3 md:gap-4">
                    <div class="bg-white p-4 md:p-5 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-between h-full">
                        <div><p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Total Active</p><h3 class="text-xl md:text-2xl font-bold text-gray-800 mt-1">${totalItems}</h3></div>
                        <div class="self-end p-2 bg-blue-50 text-blue-600 rounded-lg mt-2"><i data-lucide="package" class="w-5 h-5"></i></div>
                    </div>
                    <div class="bg-white p-4 md:p-5 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-between h-full">
                        <div><p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Assigned</p><h3 class="text-xl md:text-2xl font-bold text-gray-800 mt-1">${assignedItems}</h3></div>
                        <div class="self-end p-2 bg-indigo-50 text-indigo-600 rounded-lg mt-2"><i data-lucide="map-pin" class="w-5 h-5"></i></div>
                    </div>
                    <div class="bg-white p-4 md:p-5 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-between h-full">
                        <div><p class="text-xs font-bold text-gray-500 uppercase tracking-wider">In Storage</p><h3 class="text-xl md:text-2xl font-bold text-gray-800 mt-1">${unassignedItems}</h3></div>
                        <div class="self-end p-2 bg-orange-50 text-orange-600 rounded-lg mt-2"><i data-lucide="box" class="w-5 h-5"></i></div>
                    </div>
                    <div class="bg-white p-4 md:p-5 rounded-xl border border-gray-200 shadow-sm flex flex-col justify-between h-full">
                        <div><p class="text-xs font-bold text-gray-500 uppercase tracking-wider">Disposed</p><h3 class="text-xl md:text-2xl font-bold text-gray-800 mt-1">${disposedItems}</h3></div>
                        <div class="self-end p-2 bg-red-50 text-red-600 rounded-lg mt-2"><i data-lucide="trash-2" class="w-5 h-5"></i></div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 bg-white rounded-xl border border-gray-200 shadow-sm p-6">
                        <h3 class="font-bold text-gray-800 mb-4">Room Occupancy</h3>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 text-center">
                            <div class="p-3 bg-green-50 rounded-lg border border-green-100 flex items-center justify-between sm:block px-6 sm:px-3">
                                <span class="block text-xl font-bold text-green-700">${vacantRooms}</span>
                                <span class="text-xs font-medium text-green-600 uppercase">Vacant</span>
                            </div>
                            <div class="p-3 bg-red-50 rounded-lg border border-red-100 flex items-center justify-between sm:block px-6 sm:px-3">
                                <span class="block text-xl font-bold text-red-700">${occupiedRooms}</span>
                                <span class="text-xs font-medium text-red-600 uppercase">Occupied</span>
                            </div>
                            <div class="p-3 bg-yellow-50 rounded-lg border border-yellow-100 flex items-center justify-between sm:block px-6 sm:px-3">
                                <span class="block text-xl font-bold text-yellow-700">${maintenanceRooms}</span>
                                <span class="text-xs font-medium text-yellow-600 uppercase">Maintenance</span>
                            </div>
                        </div>
                        <div class="mt-6">
                            <h4 class="font-bold text-gray-800 mb-2">Top Sub-Categories</h4>
                            <div class="space-y-3">
                                ${Object.keys(subCategories).length > 0 ? Object.keys(subCategories)
                                    .sort((a,b) => subCategories[b] - subCategories[a])
                                    .slice(0, 5).map(cat => {
                                    const count = subCategories[cat];
                                    const pct = Math.round((count / totalItems) * 100);
                                    return `<div><div class="flex justify-between text-xs mb-1"><span class="font-medium text-gray-600">${cat}</span><span class="text-gray-400">${count} items</span></div><div class="w-full bg-gray-100 rounded-full h-2"><div class="bg-blue-600 h-2 rounded-full" style="width: ${pct}%"></div></div></div>`;
                                }).join('') : '<p class="text-sm text-gray-400 italic">No items yet.</p>'}
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl border border-gray-200 shadow-sm p-6 flex flex-col">
                        <h3 class="font-bold text-gray-800 mb-4">Quick Actions</h3>
                        <div class="space-y-3 flex-1">
                            <button onclick="app.setActiveTab('storage'); setTimeout(() => app.openAddItemModal(), 100)" class="w-full py-3 px-4 bg-blue-50 hover:bg-blue-100 text-blue-700 rounded-lg text-sm font-medium flex items-center gap-3 transition">
                                <div class="bg-blue-200 p-1.5 rounded-md"><i data-lucide="plus" class="w-4 h-4"></i></div>
                                Add New Equipment
                            </button>
                            <button onclick="app.setActiveTab('floors'); setTimeout(() => app.openAddLocationModal('floor'), 100)" class="w-full py-3 px-4 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 rounded-lg text-sm font-medium flex items-center gap-3 transition">
                                <div class="bg-indigo-200 p-1.5 rounded-md"><i data-lucide="layers" class="w-4 h-4"></i></div>
                                Create New Floor
                            </button>
                            <button onclick="app.setActiveTab('boxes'); setTimeout(() => app.openAddLocationModal('box'), 100)" class="w-full py-3 px-4 bg-orange-50 hover:bg-orange-100 text-orange-700 rounded-lg text-sm font-medium flex items-center gap-3 transition">
                                <div class="bg-orange-200 p-1.5 rounded-md"><i data-lucide="box" class="w-4 h-4"></i></div>
                                Register New Box
                            </button>
                        </div>
                    </div>
                </div>
            </div>`;
        }

        function generateStorageView() {
            const activeClass = "border-blue-600 text-blue-600 bg-blue-50";
            const inactiveClass = "border-transparent text-gray-500 hover:text-gray-700 hover:bg-gray-50";
            return `<div class="space-y-6 fade-in max-w-7xl mx-auto"><div class="flex justify-between items-center"><div><h2 class="text-2xl font-bold text-gray-800">Inventory Catalog</h2><p class="text-sm text-gray-500">Master list of all items</p></div><button onclick="app.openAddItemModal()" class="bg-blue-600 text-white px-4 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2 shadow hover:bg-blue-700 transition"><i data-lucide="plus" class="w-4 h-4"></i> <span class="hidden sm:inline">Add Item</span></button></div><div class="flex border-b border-gray-200"><button onclick="app.setStorageMode('active')" class="flex-1 pb-3 text-sm font-medium border-b-2 transition ${state.storageViewMode === 'active' ? activeClass : inactiveClass}">Active</button><button onclick="app.setStorageMode('disposal')" class="flex-1 pb-3 text-sm font-medium border-b-2 transition ${state.storageViewMode === 'disposal' ? 'border-red-500 text-red-600 bg-red-50' : inactiveClass}">Disposal</button></div><div class="relative"><i data-lucide="search" class="absolute left-3 top-3.5 text-gray-400 w-5 h-5"></i><input id="search-input" type="text" placeholder="Search items..." class="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-sm shadow-sm" oninput="app.handleSearch(event)" /></div><div id="inventory-list" class="space-y-6">${generateInventoryItems()}</div></div>`;
        }

        function generateFloorsView() { const floors = state.locations.filter(l => l.type === 'floor').sort((a, b) => a.name.localeCompare(b.name)); const header = `<div class="flex justify-between items-center"><div><h2 class="text-2xl font-bold text-gray-800">Floors</h2><p class="text-sm text-gray-500">Building layout</p></div><button onclick="app.openAddLocationModal('floor')" class="bg-indigo-600 text-white px-4 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2 shadow hover:bg-indigo-700 transition"><i data-lucide="plus" class="w-4 h-4"></i> Add Floor</button></div>`; let content = ''; if (floors.length === 0) { content = `<div class="text-center py-20 bg-white rounded-xl border border-dashed border-gray-300 mt-6"><i data-lucide="layers" class="w-12 h-12 text-gray-300 mx-auto mb-3"></i><p class="text-gray-500 font-medium">No floors yet.</p></div>`; } else { content = floors.map(floor => { const rooms = state.locations.filter(l => l.type === 'room' && l.parentId === floor.id); rooms.sort((a, b) => (a.customId || a.name).localeCompare((b.customId || b.name), undefined, { numeric: true, sensitivity: 'base' })); const roomCards = rooms.length === 0 ? `<p class="text-sm text-gray-400 italic col-span-full py-4 text-center">No rooms here.</p>` : rooms.map(room => generateLocationCard(room, 'home', 'text-indigo-600', 'bg-white', 'border-indigo-100')).join(''); return `<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mb-6 mt-6"><div class="bg-gray-50 p-4 border-b border-gray-200 flex justify-between items-center"><h3 class="font-bold text-gray-800 flex items-center gap-2 text-lg"><i data-lucide="layers" class="w-5 h-5 text-indigo-500"></i> ${floor.name} <button onclick="app.openEditLocationModal('${floor.id}')" class="text-gray-400 hover:text-blue-600 p-1 rounded-full transition"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button></h3><button onclick="app.openAddLocationModal('room', '${floor.id}')" class="text-xs bg-white border border-gray-300 px-3 py-1.5 rounded-md text-gray-700 font-medium hover:bg-gray-50 transition shadow-sm">+ Add Room</button></div><div class="p-5 grid gap-4 sm:grid-cols-2 lg:grid-cols-3">${roomCards}</div></div>`; }).join(''); } return `<div class="space-y-6 max-w-7xl mx-auto fade-in">${header}${content}</div>`; }
        function generateBoxesView() { const boxes = state.locations.filter(l => l.type === 'box'); boxes.sort((a, b) => (a.customId || a.name).localeCompare((b.customId || b.name), undefined, { numeric: true, sensitivity: 'base' })); const header = `<div class="flex justify-between items-center"><div><h2 class="text-2xl font-bold text-gray-800">Boxes</h2><p class="text-sm text-gray-500">Movable containers</p></div><button onclick="app.openAddLocationModal('box')" class="bg-orange-600 text-white px-4 py-2.5 rounded-lg text-sm font-medium flex items-center gap-2 shadow hover:bg-orange-700 transition"><i data-lucide="plus" class="w-4 h-4"></i> Add Box</button></div>`; let content = ''; if (boxes.length === 0) { content = `<div class="text-center py-20 bg-white rounded-xl border border-dashed border-gray-300 mt-6"><i data-lucide="box" class="w-12 h-12 text-gray-300 mx-auto mb-3"></i><p class="text-gray-500 font-medium">No boxes yet.</p></div>`; } else { content = `<div class="grid gap-4 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 mt-6">${boxes.map(box => generateLocationCard(box, 'box', 'text-orange-600', 'bg-white', 'border-orange-100')).join('')}</div>`; } return `<div class="space-y-6 max-w-7xl mx-auto fade-in">${header}${content}</div>`; }
        function generateActivityLogView() { const logs = state.logs || []; if (logs.length === 0) { return `<div class="flex flex-col items-center justify-center py-20 text-gray-400"><i data-lucide="clipboard-list" class="w-16 h-16 mb-4 opacity-20"></i><p>No activity recorded yet.</p></div>`; } return `<div class="space-y-4 fade-in max-w-7xl mx-auto"><h2 class="text-2xl font-bold text-gray-800">Activity Log</h2><div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div class="divide-y divide-gray-100">${logs.map(log => { const date = formatDatePH(log.timestamp); let icon = 'info'; let colorClass = 'text-gray-500 bg-gray-100'; if (log.action.includes('Added')) { icon = 'plus-circle'; colorClass = 'text-green-600 bg-green-50'; } else if (log.action.includes('Deleted')) { icon = 'trash-2'; colorClass = 'text-red-600 bg-red-50'; } else if (log.action.includes('Moved')) { icon = 'arrow-right-left'; colorClass = 'text-blue-600 bg-blue-50'; } else if (log.action.includes('Renamed')) { icon = 'edit-2'; colorClass = 'text-orange-600 bg-orange-50'; } else if (log.action.includes('Swap')) { icon = 'refresh-cw'; colorClass = 'text-purple-600 bg-purple-50'; } const userLabel = log.user ? `<span class="text-[10px] font-bold text-blue-600 bg-blue-50 px-1.5 py-0.5 rounded ml-2 uppercase tracking-wide border border-blue-100">${window.esc(log.user.split('@')[0])}</span>` : ''; return `<div class="p-4 flex gap-4 hover:bg-gray-50 transition"><div class="mt-1"><div class="p-2 rounded-full ${colorClass}"><i data-lucide="${icon}" class="w-4 h-4"></i></div></div><div class="flex-1"><div class="flex justify-between items-start"><h4 class="font-bold text-sm text-gray-900 flex items-center">${log.action} ${userLabel}</h4><span class="text-xs text-gray-400 whitespace-nowrap ml-2">${date}</span></div><p class="text-sm text-gray-600 mt-1 whitespace-pre-line">${log.details}</p></div></div>`; }).join('')}</div></div></div>`; }
        function generateSettingsView() { return `<div class="max-w-5xl mx-auto space-y-6 fade-in pb-10"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b border-gray-200 pb-4 gap-4"><div><h2 class="text-2xl font-bold text-gray-800">System Settings</h2><p class="text-sm text-gray-500">Manage categories, locations, and reports</p></div><div class="flex space-x-1 bg-gray-100 p-1 rounded-lg"><button onclick="app.setSettingsTab('categories')" class="px-4 py-2 rounded-md text-sm font-medium transition ${state.settingsTab === 'categories' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}">Categories</button><button onclick="app.setSettingsTab('locations')" class="px-4 py-2 rounded-md text-sm font-medium transition ${state.settingsTab === 'locations' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}">Locations</button><button onclick="app.setSettingsTab('reports')" class="px-4 py-2 rounded-md text-sm font-medium transition ${state.settingsTab === 'reports' ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700'}">Reports</button></div></div>${state.settingsTab === 'categories' ? generateCategorySettings() : state.settingsTab === 'locations' ? generateLocationSettings() : generateReportSettings()}<div class="mt-8 border-t border-gray-200 pt-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4"><div class="flex items-center gap-3"><div class="bg-gray-100 p-3 rounded-full"><i data-lucide="user" class="w-6 h-6 text-gray-600"></i></div><div><p class="font-bold text-gray-900">${state.user ? (state.user.displayName || 'User') : 'Guest'}</p><p class="text-xs text-gray-500">${state.user ? state.user.email : 'No email'}</p></div></div><div class="flex gap-3 w-full sm:w-auto"><button onclick="app.openEditProfileModal()" class="flex-1 sm:flex-none px-6 py-3 bg-white border border-gray-200 text-gray-700 font-bold rounded-xl hover:bg-gray-50 transition shadow-sm flex items-center justify-center gap-2"><i data-lucide="edit-3" class="w-4 h-4"></i> Edit Profile</button><button onclick="app.handleLogout()" class="flex-1 sm:flex-none px-6 py-3 bg-red-50 text-red-600 hover:bg-red-100 font-bold rounded-xl transition flex items-center justify-center gap-2"><i data-lucide="log-out" class="w-4 h-4"></i> Log Out</button></div></div></div>`; }
        function generateReportSettings() { return `<div class="grid grid-cols-1 md:grid-cols-2 gap-8"><div class="bg-white border border-gray-200 rounded-xl p-6 shadow-sm"><div class="flex items-center gap-3 mb-4"><div class="bg-red-100 p-2.5 rounded-lg text-red-600"><i data-lucide="file-text" class="w-6 h-6"></i></div><div><h3 class="text-lg font-bold text-gray-800">Generate PDF Report</h3><p class="text-sm text-gray-500">Select content to include</p></div></div><div class="space-y-4 mb-8"><label class="flex items-center gap-3 p-3 border border-gray-100 rounded-lg hover:bg-gray-50 cursor-pointer transition"><input type="checkbox" id="report-summary" checked class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"><div><span class="font-bold text-gray-700 text-sm block">Executive Summary</span><span class="text-xs text-gray-400">Stats and charts</span></div></label><label class="flex items-center gap-3 p-3 border border-gray-100 rounded-lg hover:bg-gray-50 cursor-pointer transition"><input type="checkbox" id="report-inventory" checked class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"><div><span class="font-bold text-gray-700 text-sm block">Full Inventory List</span><span class="text-xs text-gray-400">Active items</span></div></label><label class="flex items-center gap-3 p-3 border border-gray-100 rounded-lg hover:bg-gray-50 cursor-pointer transition"><input type="checkbox" id="report-locations" checked class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"><div><span class="font-bold text-gray-700 text-sm block">Location Status</span><span class="text-xs text-gray-400">Room details</span></div></label><label class="flex items-center gap-3 p-3 border border-gray-100 rounded-lg hover:bg-gray-50 cursor-pointer transition"><input type="checkbox" id="report-logs" class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500"><div><span class="font-bold text-gray-700 text-sm block">Activity Logs</span><span class="text-xs text-gray-400">Recent actions</span></div></label></div><button onclick="app.generatePDF()" class="w-full py-3 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-lg shadow-blue-200 transition flex items-center justify-center gap-2"><i data-lucide="download" class="w-5 h-5"></i> Download PDF Report</button></div><div class="bg-blue-50 border border-blue-100 rounded-xl p-6 flex flex-col justify-center items-center text-center"><img src="https://illustrations.popsy.co/amber/success.svg" class="w-48 h-48 mb-6 opacity-80" alt="Report"><h3 class="text-xl font-bold text-blue-900 mb-2">Professional Reporting</h3><p class="text-sm text-blue-700 max-w-xs">Generate clean, branded PDF reports for audits and reviews.</p></div></div>`; }
        function generateCategorySettings() { const categories = state.masterData.categories || []; if (categories.length === 0) return `<div class="text-center py-12 bg-white rounded-xl border border-dashed border-gray-300"><p class="text-gray-500 mb-4">No categories defined.</p><button onclick="app.openManageCategoryModal('add')" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold">Create First Category</button></div>`; return `<div class="grid grid-cols-1 gap-6"><div class="flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800">All Categories</h3><button onclick="app.openManageCategoryModal('add')" class="flex items-center gap-2 px-3 py-2 bg-blue-600 text-white rounded-lg text-sm font-bold shadow hover:bg-blue-700 transition"><i data-lucide="plus" class="w-4 h-4"></i> New Category</button></div><div class="space-y-4">${categories.map(cat => `<div class="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm"><div class="bg-gray-50 px-4 py-3 border-b border-gray-200 flex justify-between items-center group"><div class="font-bold text-gray-800 flex items-center gap-2"><i data-lucide="folder" class="w-4 h-4 text-blue-500"></i> ${cat.name}</div><div class="flex gap-2 opacity-100 md:opacity-0 md:group-hover:opacity-100 transition"><button onclick="app.openManageCategoryModal('rename', '${window.esc(cat.name)}')" class="p-1.5 text-gray-500 hover:text-blue-600 hover:bg-white rounded-md transition" title="Rename"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="app.deleteMasterCategory('${window.esc(cat.name)}')" class="p-1.5 text-gray-500 hover:text-red-600 hover:bg-white rounded-md transition" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div><div class="p-4"><div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">${cat.subs && cat.subs.length > 0 ? cat.subs.map(sub => `<div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg border border-gray-100 group/sub hover:border-blue-200 transition"><span class="text-sm font-medium text-gray-700">${sub}</span><div class="flex gap-1 opacity-100 md:opacity-0 md:group-hover/sub:opacity-100 transition"><button onclick="app.openMoveSubCategoryModal('${window.esc(sub)}', '${window.esc(cat.name)}')" class="p-1 text-gray-400 hover:text-orange-600" title="Move"><i data-lucide="arrow-right-left" class="w-3.5 h-3.5"></i></button><button onclick="app.openManageSubCategoryModal('rename', '${window.esc(cat.name)}', '${window.esc(sub)}')" class="p-1 text-gray-400 hover:text-blue-600" title="Rename"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button><button onclick="app.deleteMasterSubCategory('${window.esc(cat.name)}', '${window.esc(sub)}')" class="p-1 text-gray-400 hover:text-red-600" title="Delete"><i data-lucide="x" class="w-3.5 h-3.5"></i></button></div></div>`).join('') : '<span class="text-sm text-gray-400 italic">No sub-categories</span>'}<button onclick="app.openManageSubCategoryModal('add', '${window.esc(cat.name)}')" class="flex items-center justify-center gap-2 p-3 border border-dashed border-gray-300 rounded-lg text-gray-400 hover:text-blue-600 hover:border-blue-300 hover:bg-blue-50 transition text-sm font-medium"><i data-lucide="plus" class="w-4 h-4"></i> Add Sub-Category</button></div></div></div>`).join('')}</div></div>`; }
        function generateLocationSettings() { const floors = state.locations.filter(l => l.type === 'floor').sort((a,b) => a.name.localeCompare(b.name)); const boxes = state.locations.filter(l => l.type === 'box').sort((a,b) => a.name.localeCompare(b.name)); return `<div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div class="space-y-4"><div class="flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800">Floors & Rooms</h3><button onclick="app.openAddLocationModal('floor')" class="px-3 py-1.5 bg-indigo-50 text-indigo-700 rounded-lg text-xs font-bold hover:bg-indigo-100 transition">+ Add Floor</button></div><div class="space-y-4">${floors.map(floor => { const rooms = state.locations.filter(l => l.parentId === floor.id).sort((a,b) => a.name.localeCompare(b.name)); return `<div class="bg-white border border-gray-200 rounded-lg overflow-hidden"><div class="bg-gray-50 px-3 py-2 border-b border-gray-200 flex justify-between items-center"><span class="font-bold text-gray-800 text-sm flex items-center gap-2"><i data-lucide="layers" class="w-4 h-4 text-indigo-500"></i> ${floor.name}</span><div class="flex gap-1"><button onclick="app.openAddLocationModal('room', '${floor.id}')" class="text-xs bg-white border border-gray-300 px-2 py-0.5 rounded text-gray-600 hover:bg-gray-50">+ Room</button><button onclick="app.openEditLocationModal('${floor.id}')" class="text-gray-400 hover:text-blue-600 p-1"><i data-lucide="settings-2" class="w-3.5 h-3.5"></i></button></div></div><div class="p-2 space-y-1">${rooms.length > 0 ? rooms.map(room => `<div class="flex justify-between items-center p-2 rounded hover:bg-gray-50 group"><div class="flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full ${room.status === 'occupied' ? 'bg-red-500' : (room.status === 'maintenance' ? 'bg-yellow-500' : 'bg-green-500')}"></div><span class="text-sm text-gray-700">${room.name}</span><span class="text-[10px] text-gray-400 font-mono border px-1 rounded">${room.customId || 'N/A'}</span></div><button onclick="app.openEditLocationModal('${room.id}')" class="text-gray-300 hover:text-blue-600 p-1 opacity-0 group-hover:opacity-100 transition"><i data-lucide="pencil" class="w-3 h-3"></i></button></div>`).join('') : '<div class="p-2 text-xs text-gray-400 italic text-center">No rooms</div>'}</div></div>`; }).join('')}</div></div><div class="space-y-4"><div class="flex justify-between items-center"><h3 class="text-lg font-bold text-gray-800">Boxes & Containers</h3><button onclick="app.openAddLocationModal('box')" class="px-3 py-1.5 bg-orange-50 text-orange-700 rounded-lg text-xs font-bold hover:bg-orange-100 transition">+ Add Box</button></div><div class="bg-white border border-gray-200 rounded-xl p-4">${boxes.length > 0 ? `<div class="grid grid-cols-2 gap-3">${boxes.map(box => `<div class="flex justify-between items-center p-2 border border-gray-100 rounded-lg hover:border-orange-200 group"><div class="flex items-center gap-2"><i data-lucide="box" class="w-4 h-4 text-orange-500"></i><span class="text-sm font-medium text-gray-700 truncate">${box.name}</span></div><button onclick="app.openEditLocationModal('${box.id}')" class="text-gray-300 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button></div>`).join('')}</div>` : '<div class="text-center py-8 text-gray-400 italic">No boxes registered.</div>'}</div></div></div>`; }
        function generateInventoryItems() { const term = state.searchTerm.toLowerCase(); const isDisposalMode = state.storageViewMode === 'disposal'; let filtered = state.inventory.filter(item => { const matchesMode = isDisposalMode ? item.isDisposed : !item.isDisposed; const matchesTerm = item.name.toLowerCase().includes(term) || item.equipmentId.toLowerCase().includes(term) || (item.category && item.category.toLowerCase().includes(term)); return matchesMode && matchesTerm; }); if (filtered.length === 0 && (state.masterData.categories || []).length === 0) { const emptyMsg = isDisposalMode ? "Pullout bin is empty." : "No active items found."; return `<div class="flex flex-col items-center justify-center py-20 text-gray-400"><i data-lucide="${isDisposalMode ? 'trash-2' : 'package-open'}" class="w-16 h-16 mb-4 opacity-20"></i><p>${emptyMsg}</p></div>`; } const grouped = {}; if (!isDisposalMode) { (state.masterData.categories || []).forEach(cat => { grouped[cat.name] = {}; if(cat.subs) { cat.subs.forEach(sub => { grouped[cat.name][sub] = {}; }); } }); } filtered.forEach(item => { const cat = item.category || 'Uncategorized'; const sub = item.subCategory || 'General'; const name = item.name || 'Unnamed'; if (!grouped[cat]) grouped[cat] = {}; if (!grouped[cat][sub]) grouped[cat][sub] = {}; if (!grouped[cat][sub][name]) grouped[cat][sub][name] = []; grouped[cat][sub][name].push(item); }); let html = ''; Object.keys(grouped).sort().forEach(cat => { const subKeys = Object.keys(grouped[cat]).sort(); html += `<div class="bg-white border border-gray-200 rounded-xl overflow-hidden shadow-sm mb-4">`; html += `<div class="bg-gray-50 px-4 py-3 border-b border-gray-200 font-bold text-gray-700 flex items-center gap-2"><div class="flex items-center gap-2 flex-1"><i data-lucide="folder" class="w-4 h-4 text-blue-500"></i> ${cat}</div>${!isDisposalMode ? `<div class="flex gap-1"><button onclick="app.openRenameModal('category', '${window.esc(cat)}')" class="text-gray-300 hover:text-blue-500 p-1 rounded transition" title="Rename"><i data-lucide="pencil" class="w-3.5 h-3.5"></i></button></div>` : ''}</div>`; html += `<div class="p-4 space-y-4">`; if (subKeys.length === 0) { html += `<div class="text-xs text-gray-400 italic">No sub-categories defined.</div>`; } subKeys.forEach(sub => { const itemNames = Object.keys(grouped[cat][sub]).sort(); html += `<div class="space-y-3">`; html += `<h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2 group/sub"><span class="w-1.5 h-1.5 rounded-full bg-gray-300"></span> ${sub}${!isDisposalMode ? `<button onclick="app.openAddItemModal({category: '${window.esc(cat)}', subCategory: '${window.esc(sub)}'})" class="text-gray-300 hover:text-blue-600 p-1 rounded transition opacity-0 group-hover/sub:opacity-100" title="Add New Item to ${sub}"><i data-lucide="plus-circle" class="w-3.5 h-3.5"></i></button><button onclick="app.openRenameModal('subCategory', '${window.esc(sub)}', '${window.esc(cat)}')" class="text-gray-300 hover:text-blue-500 p-1 rounded transition opacity-0 group-hover/sub:opacity-100" title="Rename"><i data-lucide="pencil" class="w-3 h-3"></i></button>` : ''}</h4>`; if (itemNames.length === 0) { html += `<div class="text-xs text-gray-300 italic pl-4 py-2 border border-dashed border-gray-200 rounded">No items in this category yet.</div>`; } else { html += `<div class="grid gap-3 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">`; itemNames.forEach(name => { const items = grouped[cat][sub][name]; items.sort((a,b) => a.equipmentId.localeCompare(b.equipmentId, undefined, {numeric: true})); const stockCount = items.filter(i => !i.locationId).length; const totalCount = items.length; const hasStock = stockCount > 0; const cardBg = "bg-white"; const badgeColor = hasStock ? "bg-blue-100 text-blue-700" : (isDisposalMode ? "bg-red-100 text-red-700" : "bg-gray-100 text-gray-500"); let badgeText = ""; if (isDisposalMode) { badgeText = `${totalCount} Pulled Out`; } else { if (hasStock) { badgeText = `${stockCount} Available`; } else { badgeText = "No Stock"; } } let itemsListHtml = ''; let itemsToShow = items; if (!isDisposalMode) { itemsToShow = items.filter(i => !i.locationId); } if (itemsToShow.length > 0) { itemsListHtml = itemsToShow.map((i, index) => { const statusColor = i.condition === 'Defective' ? 'bg-red-500' : 'bg-green-500'; const isLastItem = index === itemsToShow.length - 1; let actionButtons = ''; if (!isDisposalMode) { actionButtons = `<button onclick="app.openMoveItemModal('${i.id}')" class="text-gray-400 hover:text-blue-600 p-1" title="Move Location"><i data-lucide="arrow-right-left" class="w-3.5 h-3.5"></i></button>${isLastItem ? `<button onclick="app.deleteItem('${i.id}', '${window.esc(i.name)}', '${window.esc(i.equipmentId)}', false)" class="text-gray-300 hover:text-red-500 p-1" title="Delete (Reuse ID)"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>` : '<span class="w-5.5 inline-block"></span>'}`; } else { actionButtons = `<button onclick="app.toggleDisposal('${i.id}', '${window.esc(i.name)}', '${window.esc(i.equipmentId)}', true)" class="text-green-600 hover:text-green-800 p-1" title="Restore to Inventory"><i data-lucide="rotate-ccw" class="w-3.5 h-3.5"></i></button><button onclick="app.deleteItem('${i.id}', '${window.esc(i.name)}', '${window.esc(i.equipmentId)}', true)" class="text-red-400 hover:text-red-700 p-1" title="Delete Permanently"><i data-lucide="x-circle" class="w-3.5 h-3.5"></i></button>`; } return `<div class="flex justify-between items-center text-xs p-2 bg-gray-50 rounded border border-gray-100 hover:border-blue-200 transition group/item"><div class="flex items-center gap-2 flex-1 min-w-0"><button onclick="app.toggleCondition('${i.id}', '${i.condition || 'Working'}')" class="w-2.5 h-2.5 rounded-full ${statusColor} hover:scale-125 transition flex-none" title="${i.condition || 'Working'} (Click to toggle)"></button><span class="font-mono font-bold text-blue-600 flex-none">${i.equipmentId}</span>${!isDisposalMode ? `<div class="truncate pl-2 text-[10px] text-right flex-1 text-gray-400 italic">In Storage</div>` : ''}</div><div class="flex gap-1 pl-2 transition">${actionButtons}</div></div>`}).join(''); } else { const msg = isDisposalMode ? "No items" : "No stock available"; itemsListHtml = `<div class="text-[10px] text-gray-400 italic text-center py-4 bg-gray-50 rounded border border-dashed border-gray-200 leading-relaxed">${msg}</div>`; } html += `<div class="${cardBg} border border-gray-200 rounded-lg p-4 hover:shadow-md transition duration-200 flex flex-col h-full relative group/card"><div class="flex justify-between items-start mb-3 pb-2 border-b border-gray-100"><div><h3 class="font-bold text-gray-900 text-sm leading-tight pr-2 flex items-center gap-1">${name}${!isDisposalMode ? `<button onclick="app.openEditItemNameModal('${items[0].id}')" class="text-gray-300 hover:text-blue-600 ml-1 inline-block"><i data-lucide="pencil" class="w-3 h-3"></i></button>` : ''}</h3><span class="${badgeColor} text-[10px] font-bold px-2 py-0.5 rounded-full inline-block mt-1">${badgeText}</span></div>${!isDisposalMode ? `<button onclick="app.openAddStockModal('${window.esc(cat)}', '${window.esc(sub)}', '${window.esc(name)}')" class="text-blue-600 hover:bg-blue-50 p-1 rounded-full transition" title="Add Stock"><i data-lucide="plus-circle" class="w-5 h-5"></i></button>` : ''}</div><div class="flex-1 overflow-y-auto max-h-48 space-y-1 custom-scrollbar pr-1">${itemsListHtml}</div></div>`; }); html += `</div>`; } html += `</div>`; }); html += `</div></div>`; }); return html; }

        // --- Global App Object ---
        window.app = {
            setActiveTab: (tab) => {
                state.activeTab = tab;
                updateNavUI();
                renderMainContent();
            },
            setStorageMode: (mode) => {
                state.storageViewMode = mode;
                renderMainContent();
            },
            setSettingsTab: (tab) => {
                state.settingsTab = tab;
                renderMainContent();
            },
            openAddItemModal: (data) => renderModal('addItem', data),
            openAddLocationModal: (type, parentId) => renderModal('addLocation', { type, parentId }),
            openEditLocationModal: (locationId) => renderModal('editLocation', { locationId }),
            openMoveItemModal: (itemId) => renderModal('moveItem', { itemId }),
            openLocationDetail: (locationId) => renderModal('locationDetail', { locationId }),
            openSwapModal: (locationId) => renderModal('swapContents', { locationId }),
            openRenameModal: (type, currentVal, parentCat, parentSub) => renderModal('rename', { type, currentVal, parentCat, parentSub }),
            openAddStockModal: (category, subCategory, name) => renderModal('addStock', { category, subCategory, name }),
            openAddItemsModal: (locationId) => renderModal('addItems', { locationId }),
            openEditItemNameModal: (itemId) => renderModal('editItemName', { itemId }), // New
            openEditProfileModal: () => renderModal('editProfile'),
            
            // ... [Keep all other app methods as is] ...
            toggleAuthMode: () => {
                state.authMode = state.authMode === 'login' ? 'register' : 'login';
                document.getElementById('auth-container').innerHTML = generateAuthView();
                lucide.createIcons();
            },
            setAuthMode: (mode) => {
                state.authMode = mode;
                document.getElementById('auth-container').innerHTML = generateAuthView();
                lucide.createIcons();
            },
            toggleUserMenu: () => {
                const dropdown = document.getElementById('user-menu-dropdown');
                if (dropdown) {
                    dropdown.classList.toggle('hidden');
                }
            },
            handleLogin: async (e) => {
                e.preventDefault();
                const email = e.target.email.value;
                const password = e.target.password.value;
                
                state.loadingAuth = true;
                document.getElementById('auth-container').innerHTML = generateAuthView(); // update loading state
                lucide.createIcons();

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // Reset attempts on success (this line runs only if success)
                    state.loginAttempts = 0;
                    showToast("Signed In Successfully");
                } catch (error) {
                    state.loginAttempts++;
                    let msg = "Login failed. Check credentials.";
                    if (error.code === 'auth/user-not-found') msg = "User not found. Register first?";
                    if (error.code === 'auth/wrong-password') msg = "Incorrect password.";
                    if (error.code === 'auth/operation-not-allowed') {
                         msg = `Error: Email/Password login is disabled for project "${firebaseConfig.projectId}". Please check your Firebase Console.`;
                         alert(msg);
                    }
                    showToast(msg, 'error');
                } finally {
                    state.loadingAuth = false;
                    // Only refresh view if still on auth screen (not logged in)
                    if (!auth.currentUser) {
                         document.getElementById('auth-container').innerHTML = generateAuthView();
                         lucide.createIcons();
                    }
                }
            },
            handleRegister: async (e) => {
                e.preventDefault();
                const nickname = e.target.nickname.value.trim();
                const email = e.target.email.value;
                const password = e.target.password.value;
                const role = e.target.role ? e.target.role.value : 'Live Operator'; // Default if not selected
                
                if (!nickname) return showToast("Nickname is required", 'error');
                if (!role) return showToast("Role is required", 'error');

                state.loadingAuth = true;
                document.getElementById('auth-container').innerHTML = generateAuthView(); 
                lucide.createIcons();
                
                try {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    const user = userCredential.user;
                    
                    // Update Profile
                    await updateProfile(user, { displayName: nickname });
                    
                    // Save Role to Firestore
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_roles', user.uid), {
                        role: role,
                        email: email,
                        nickname: nickname
                    });

                    showToast(`Welcome, ${nickname}!`);
                    // state.user will be set by onAuthStateChanged
                } catch (error) {
                    console.error("Registration Error:", error);
                    let msg = error.message;
                    if (error.code === 'auth/email-already-in-use') msg = "Email already in use. Please sign in.";
                    if (error.code === 'auth/weak-password') msg = "Password is too weak (min 6 chars).";
                    if (error.code === 'auth/operation-not-allowed') {
                        msg = `SETUP REQUIRED: Enable 'Email/Password' in Firebase Console for project "${firebaseConfig.projectId}".`;
                        alert(msg); // Force alert for visibility
                    }
                    
                    showToast(msg, 'error');
                } finally {
                    state.loadingAuth = false;
                    if (!auth.currentUser) {
                        document.getElementById('auth-container').innerHTML = generateAuthView();
                        lucide.createIcons();
                    }
                }
            },
            handleForgotPassword: async (e) => {
                e.preventDefault();
                const email = e.target.email.value.trim();
                if (!email) return showToast("Please enter your email", 'error');
                
                state.loadingAuth = true;
                document.getElementById('auth-container').innerHTML = generateAuthView();
                
                try {
                    await sendPasswordResetEmail(auth, email);
                    showToast("Reset link sent! Check your inbox.");
                    state.authMode = 'login';
                    state.loginAttempts = 0; // Reset attempts after sending
                } catch (error) {
                    showToast(error.message, 'error');
                } finally {
                    state.loadingAuth = false;
                    document.getElementById('auth-container').innerHTML = generateAuthView();
                    lucide.createIcons();
                }
            },
            handleLogout: async () => {
                try {
                    await signOut(auth);
                    showToast("Logged Out");
                    state.userRole = null; // Clear role on logout
                } catch (error) {
                    console.error(error);
                }
            },
            submitEditProfile: async (e) => {
                e.preventDefault();
                const nickname = e.target.nickname.value.trim();
                const email = e.target.email.value.trim();
                const password = e.target.password.value;
                const user = auth.currentUser;
                
                if (!user) return;
                
                try {
                    let updated = false;
                    let changes = [];
                    
                    if (nickname !== user.displayName) {
                        await updateProfile(user, { displayName: nickname });
                        updated = true;
                        changes.push(`Nickname changed to "${nickname}"`);
                    }
                    
                    if (email !== user.email) {
                        await updateEmail(user, email);
                        updated = true;
                        changes.push(`Email changed to "${email}"`);
                    }

                    if (password) {
                        await updatePassword(user, password);
                        updated = true;
                        changes.push("Password updated");
                    }
                    
                    if (updated) {
                        // Manually update local state to reflect immediately
                        state.user = { ...user, displayName: nickname, email: email };
                        // Also update role doc if needed (for consistency)
                         await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_roles', user.uid), {
                            role: state.userRole,
                            email: email,
                            nickname: nickname
                        }, { merge: true });

                        await logActivity('Profile Updated', `User profile updated: ${changes.join(', ')}`);
                        showToast("Profile Updated");
                        app.closeModal();
                        renderMainContent(); // Update settings view
                        // Update Header Name
                        const headerDisplay = document.getElementById('header-user-name');
                        const mobileHeaderDisplay = document.getElementById('header-user-name-mobile');
                        if(headerDisplay) headerDisplay.innerText = nickname || email;
                        if(mobileHeaderDisplay) mobileHeaderDisplay.innerText = nickname || email;
                    } else {
                        app.closeModal();
                    }
                } catch (error) {
                    console.error(error);
                    if (error.code === 'auth/requires-recent-login') {
                        showToast("Please log out and log in again to change email/password.", 'error');
                    } else {
                        showToast("Update failed: " + error.message, 'error');
                    }
                }
            },
            handleFileUpload: (e) => {
                 const file = e.target.files[0];
                 if (!file) return;
                 
                 Papa.parse(file, {
                     header: true,
                     skipEmptyLines: true,
                     complete: async (results) => {
                         const rows = results.data;
                         if (!rows || rows.length === 0) return;
                         
                         let added = 0;
                         let skipped = 0;
                         const batch = writeBatch(db);
                         
                         rows.forEach(row => {
                             const id = row['Equipment ID'] || row['ID'] || `IMP-${Date.now()}-${Math.floor(Math.random()*1000)}`;
                             
                             // Skip if exists (Strict Duplicate Check)
                             if (state.inventory.some(i => i.equipmentId === id)) {
                                 skipped++;
                                 return;
                             }
                             
                             const newItem = {
                                 equipmentId: id,
                                 name: row['Name'] || row['Item Name'] || 'Imported Item',
                                 category: row['Category'] || 'Uncategorized',
                                 subCategory: row['Sub-Category'] || 'General',
                                 condition: row['Condition'] || 'Working',
                                 locationId: null, // Basic import goes to storage
                                 isDisposed: false,
                                 createdAt: new Date().toISOString()
                             };
                             
                             const ref = doc(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'));
                             batch.set(ref, newItem);
                             added++;
                         });
                         
                         if(added > 0) {
                             await batch.commit();
                             let msg = `Imported ${added} items successfully.`;
                             if(skipped > 0) msg += ` Skipped ${skipped} duplicates.`;
                             showToast(msg);
                             app.setActiveTab('storage');
                         } else {
                             alert(`No new items imported. ${skipped} duplicates were found and skipped.`);
                         }
                     }
                 });
            },
            triggerImport: () => document.getElementById('csv-upload').click(),
            
            // Settings Modals
            openManageCategoryModal: (action, name) => renderModal('manageCategory', { action, name }),
            openManageSubCategoryModal: (action, parentCat, name) => renderModal('manageSubCategory', { action, parentCat, name }),
            openMoveSubCategoryModal: (subName, currentParent) => renderModal('moveSubCategory', { subName, currentParent }),

            updateSubCategoryOptions: (category) => {
                const subSelect = document.getElementById('input-subcategory');
                subSelect.innerHTML = '<option value="" disabled selected>Select...</option>';
                const catObj = state.masterData.categories.find(c => c.name === category);
                if (catObj && catObj.subs) {
                    catObj.subs.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = s;
                        opt.innerText = s;
                        subSelect.appendChild(opt);
                    });
                }
            },

            // Modal Controls
            closeModal: () => {
                state.currentModal = null;
                document.getElementById('modal-container').classList.add('hidden');
                document.getElementById('modal-content').innerHTML = '';
            },
            
            // Confirm Modal Controls
            openConfirmModal: (msg, actionFn) => {
                state.pendingAction = actionFn;
                document.getElementById('confirm-message').innerText = msg;
                document.getElementById('confirm-modal').classList.remove('hidden');
            },
            closeConfirmModal: () => {
                state.pendingAction = null;
                document.getElementById('confirm-modal').classList.add('hidden');
            },
            executePendingAction: async () => {
                if (state.pendingAction) {
                    await state.pendingAction();
                }
                app.closeConfirmModal();
            },

            handleSearch: (e) => {
                state.searchTerm = e.target.value;
                renderStorageList(); 
            },
            filterAddItems: (e) => {
                const term = e.target.value.toLowerCase();
                const groups = document.querySelectorAll('.add-item-group');
                groups.forEach(g => {
                    const text = g.dataset.search.toLowerCase();
                    g.style.display = text.includes(term) ? 'block' : 'none';
                });
            },
            toggleSelectAll: (checkbox) => {
                const group = checkbox.closest('.add-item-group');
                const inputs = group.querySelectorAll('.item-checkbox');
                inputs.forEach(input => input.checked = checkbox.checked);
            },
            generateIdFromSubCategory: (subCategory) => {
                if (!subCategory) return;
                let prefix = subCategory.split(' ').map(word => word[0]).join('').toUpperCase();
                if (prefix.length < 2) prefix = subCategory.substring(0, 2).toUpperCase();
                
                const newId = app.generateNextId(prefix);
                const idInput = document.getElementById('input-equipment-id');
                if (idInput) {
                    idInput.value = newId;
                    app.checkIdAvailability(idInput); // Check the generated ID immediately
                }
            },
            
            // NEW FUNCTION: Check ID availability in real-time
            checkIdAvailability: (input) => {
                const id = input.value.trim().toUpperCase();
                const feedbackIcon = input.parentElement.querySelector('#id-feedback');
                const errorMsg = input.parentElement.parentElement.querySelector('#id-error-msg');
                const saveBtn = document.getElementById('btn-save-item');

                // Reset state
                input.classList.remove('border-red-500', 'focus:border-red-500', 'bg-red-50');
                input.classList.add('border-gray-200', 'bg-gray-100');
                if (feedbackIcon) feedbackIcon.classList.add('hidden');
                if (errorMsg) errorMsg.classList.add('hidden');
                if (saveBtn) { saveBtn.disabled = false; saveBtn.classList.remove('opacity-50', 'cursor-not-allowed'); }

                if (!id) return;

                // 1. Check Active Inventory
                const existingItem = state.inventory.find(i => i.equipmentId === id && !i.isDisposed);
                // 2. Check Retired/Disposed IDs
                const isRetired = (state.masterData.retiredIds || []).includes(id);
                // 3. Check Disposed Inventory (soft deleted but still in DB)
                const isDisposedInDB = state.inventory.some(i => i.equipmentId === id && i.isDisposed);

                if (existingItem || isRetired || isDisposedInDB) {
                    // ID IS TAKEN
                    input.classList.remove('border-gray-200', 'bg-gray-100');
                    input.classList.add('border-red-500', 'focus:border-red-500', 'bg-red-50');
                    if (feedbackIcon) feedbackIcon.classList.remove('hidden');
                    if (errorMsg) {
                        let msg = "ID is taken!";
                        if (existingItem) msg = `Duplicate! Assigned to: ${existingItem.name}`;
                        else if (isRetired || isDisposedInDB) msg = "ID is retired/disposed.";
                        errorMsg.innerText = msg;
                        errorMsg.classList.remove('hidden');
                    }
                    if (saveBtn) { saveBtn.disabled = true; saveBtn.classList.add('opacity-50', 'cursor-not-allowed'); }
                    lucide.createIcons();
                }
            },

            // SMART ID GENERATOR: Skips permanently retired IDs
            generateNextId: (rawPrefix) => {
                // Remove trailing dash if present to avoid double dash in regex
                const prefix = rawPrefix.endsWith('-') ? rawPrefix.slice(0, -1) : rawPrefix;
                
                // Matches "PREFIX-123" or "PREFIX123"
                const regex = new RegExp(`^${prefix}-?(\\d+)$`);

                // 1. Get numbers from active inventory
                const inventoryNumbers = state.inventory
                    .filter(i => i.equipmentId && i.equipmentId.toUpperCase().match(regex))
                    .map(i => parseInt(i.equipmentId.toUpperCase().match(regex)[1], 10));

                // 2. Get numbers from retired IDs (Pullout deletions)
                const retiredNumbers = (state.masterData.retiredIds || [])
                    .filter(id => id.toUpperCase().match(regex))
                    .map(id => parseInt(id.toUpperCase().match(regex)[1], 10));

                // 3. Combine into a set of "unavailable" numbers
                const usedNumbers = new Set([...inventoryNumbers, ...retiredNumbers]);

                // 4. Find the first gap (smallest number starting from 1 that isn't used)
                let nextNum = 1;
                while (usedNumbers.has(nextNum)) {
                    nextNum++;
                }

                return `${prefix}-${String(nextNum).padStart(4, '0')}`;
            },

            submitAddItem: async (e) => {
                e.preventDefault();
                // Security Check
                if (!isManager()) return showToast("Unauthorized: Only managers can add items.", 'error');

                const form = e.target;
                const quantity = parseInt(form.quantity.value) || 1;
                let currentIdString = form.equipmentId.value.trim().toUpperCase(); 

                // --- GOLDEN RULE CHECK: DUPLICATE ID PREVENTION ---
                const checkDuplicate = (idToCheck) => {
                    const activeDup = state.inventory.find(i => i.equipmentId === idToCheck && !i.isDisposed);
                    if (activeDup) return `ID ${idToCheck} is already used by "${activeDup.name}" in ${getLocationNamePlain(activeDup.locationId)}.`;
                    
                    const disposedDup = state.inventory.find(i => i.equipmentId === idToCheck && i.isDisposed);
                    if (disposedDup) return `ID ${idToCheck} belongs to a disposed item ("${disposedDup.name}"). Restoration required instead of creation.`;

                    const retiredDup = (state.masterData.retiredIds || []).includes(idToCheck);
                    if (retiredDup) return `ID ${idToCheck} is permanently retired.`;
                    
                    return null;
                };

                // Regex to split "CAM-001" into "CAM-" and "001" or "CAM" and "001"
                const match = currentIdString.match(/^(.*?)(\d+)$/);
                
                // Case 1: Non-numeric ID (Single Item)
                if (!match) {
                    if (quantity > 1) {
                        alert("To add multiple items, the ID must end with a number.");
                        return;
                    }
                    
                    const duplicateError = checkDuplicate(currentIdString);
                    if (duplicateError) {
                        app.openConfirmModal(`ERROR: ${duplicateError}\n\nGolden Rule: IDs must be unique across all categories.`, null);
                        // Hack to hide the confirm button on this specific error modal if we wanted, 
                        // but re-using confirm modal as an alert is fine for now, just don't pass an action.
                        return;
                    }
                    
                    // Create single item logic
                    try {
                        const ref = doc(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'));
                        await setDoc(ref, {
                            equipmentId: currentIdString,
                            name: form.name.value,
                            category: form.category.value,
                            subCategory: form.subCategory.value,
                            condition: 'Working',
                            isDisposed: false,
                            quantity: 1, 
                            locationId: null,
                            createdAt: new Date().toISOString()
                        });
                        await logActivity('Item Added', `Added 1 item: ${currentIdString} - ${form.name.value}`);
                        app.closeModal();
                        showToast("Item Added");
                    } catch (err) { console.error(err); showToast("Error saving item.", 'error'); }
                    return;
                }

                // Case 2: Numbered IDs (Single or Bulk)
                const prefix = match[1]; 
                let nextNum = parseInt(match[2], 10); 
                const padding = match[2].length; 

                const itemsToCreate = [];
                let createdCount = 0;
                let attempts = 0;
                const maxAttempts = quantity + 500; // Safety limit to prevent infinite loops

                // Smart Loop: Find valid IDs skipping existing and retired
                while (createdCount < quantity && attempts < maxAttempts) {
                    const candidateId = `${prefix}${String(nextNum).padStart(padding, '0')}`;
                    
                    // Re-use the check function for consistency
                    const error = checkDuplicate(candidateId);

                    if (!error) {
                        itemsToCreate.push({
                            equipmentId: candidateId,
                            name: form.name.value,
                            category: form.category.value,
                            subCategory: form.subCategory.value,
                            condition: 'Working',
                            isDisposed: false,
                            quantity: 1, 
                            locationId: null,
                            createdAt: new Date().toISOString()
                        });
                        createdCount++;
                    }
                    // If duplicate, we just skip it and try the next number (Smart Auto-Increment)
                    nextNum++;
                    attempts++;
                }

                if (createdCount === 0) {
                    alert("Could not generate any valid IDs. All IDs in this range seem to be taken.");
                    return;
                }

                if (createdCount < quantity) {
                    if(!confirm(`Only ${createdCount} valid unique IDs could be generated out of ${quantity} requested (others were taken). Continue?`)) return;
                }

                try {
                    const batch = writeBatch(db);
                    itemsToCreate.forEach(item => {
                        const ref = doc(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'));
                        batch.set(ref, item);
                    });
                    await batch.commit();
                    
                    // Improved Log message
                    const rangeMsg = createdCount > 1 
                        ? `from ${itemsToCreate[0].equipmentId} to ${itemsToCreate[itemsToCreate.length-1].equipmentId}`
                        : itemsToCreate[0].equipmentId;
                        
                    await logActivity('Item Added', `Added ${createdCount} items (${form.name.value}) ${rangeMsg}`);
                    app.closeModal();
                    showToast(`${createdCount} Items Added`);
                } catch (err) { console.error(err); showToast("Error saving items.", 'error'); }
            },

            submitEditItemName: async (e, oldName, category, subCategory) => { 
                e.preventDefault(); 
                if (!isManager()) return showToast("Unauthorized: Only managers can rename items.", 'error');

                const newName = e.target.newName.value.trim(); if (!newName || newName === oldName) { app.closeModal(); return; } const itemsToUpdate = state.inventory.filter(i => i.name === oldName && i.category === category && i.subCategory === subCategory); if (itemsToUpdate.length === 0) return; try { const batch = writeBatch(db); itemsToUpdate.forEach(item => { const ref = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', item.id); batch.update(ref, { name: newName }); }); await batch.commit(); await logActivity('Item Renamed', `Renamed "${oldName}" to "${newName}" (${itemsToUpdate.length} items)`); app.closeModal(); showToast("Items Renamed"); } catch (err) { console.error(err); showToast("Error renaming items", 'error'); } 
            },

            submitSwap: async (sourceId, targetId, swapType) => { if (!targetId || sourceId === targetId) return; try { const batch = writeBatch(db); const sourceItems = state.inventory.filter(i => i.locationId === sourceId); const targetItems = state.inventory.filter(i => i.locationId === targetId); sourceItems.forEach(item => { const ref = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', item.id); batch.update(ref, { locationId: targetId }); }); targetItems.forEach(item => { const ref = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', item.id); batch.update(ref, { locationId: sourceId }); }); const sourceName = getLocationNamePlain(sourceId); const targetName = getLocationNamePlain(targetId); if (swapType === 'room') { const sourceLoc = state.locations.find(l => l.id === sourceId); const targetLoc = state.locations.find(l => l.id === targetId); if (sourceLoc && targetLoc) { const sourceRef = doc(db, 'artifacts', appId, 'public', 'data', 'locations', sourceId); const targetRef = doc(db, 'artifacts', appId, 'public', 'data', 'locations', targetId); batch.update(sourceRef, { name: targetLoc.name, status: targetLoc.status || 'vacant' }); batch.update(targetRef, { name: sourceLoc.name, status: sourceLoc.status || 'vacant' }); } } await batch.commit(); await logActivity('Swap Executed', `Swapped ${swapType} between ${sourceName} and ${targetName}`); app.closeModal(); showToast("Swap Complete"); } catch (err) { console.error(err); showToast("Failed to swap.", 'error'); } },

            updateRoomStatus: async (locationId, newStatus) => { 
                if (!isManager()) return showToast("Unauthorized: Only managers can update status.", 'error');
                try { const ref = doc(db, 'artifacts', appId, 'public', 'data', 'locations', locationId); await updateDoc(ref, { status: newStatus }); const locName = getLocationNamePlain(locationId); await logActivity('Status Changed', `${locName} status set to ${newStatus}`); } catch (err) { console.error(err); showToast("Error updating status", 'error'); } 
            },

            refreshModal: () => { if (state.currentModal && state.currentModal.type === 'locationDetail') { renderModal(state.currentModal.type, state.currentModal.data); } },
            toggleCondition: async (id, currentCondition) => { const newCondition = currentCondition === 'Working' ? 'Defective' : 'Working'; try { const ref = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id); await updateDoc(ref, { condition: newCondition }); showToast(`Condition set to ${newCondition}`); } catch (e) { console.error(e); showToast('Error updating condition', 'error'); } },

            deleteItem: (id, name, equipId, permanent) => { 
                const doDelete = async () => { 
                    if (!isManager()) return showToast("Unauthorized", 'error');
                    try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id)); if (permanent) { const retiredRef = doc(db, 'artifacts', appId, 'public', 'data', 'global_settings', 'masterData'); const currentRetired = state.masterData.retiredIds || []; if (!currentRetired.includes(equipId)) { await updateDoc(retiredRef, { retiredIds: [...currentRetired, equipId] }); } } await logActivity('Item Deleted', `Deleted ${name} (${equipId}) ${permanent ? 'permanently' : ''}`); showToast('Item deleted'); } catch(e) { console.error(e); showToast('Delete failed', 'error'); } }; app.openConfirmModal(`Are you sure you want to delete ${name}?`, doDelete); 
            },

            toggleDisposal: async (id, name, equipId, restore) => { 
                if (!isManager()) return showToast("Unauthorized", 'error');
                try { const ref = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', id); await updateDoc(ref, { isDisposed: !restore, locationId: null }); await logActivity('Item Status', `${restore ? 'Restored' : 'Disposed'} ${name} (${equipId})`); showToast(restore ? 'Item Restored' : 'Item Disposed'); } catch(e) { console.error(e); showToast('Action failed', 'error'); } 
            },

            submitMoveItem: async (itemId, locationId, name, equipId) => { try { const ref = doc(db, 'artifacts', appId, 'public', 'data', 'inventory', itemId); if (locationId === 'PULLOUT') { await updateDoc(ref, { isDisposed: true, locationId: null }); await logActivity('Item Moved', `Moved ${name} (${equipId}) to Pullout`); } else { const finalLoc = locationId === "" ? null : locationId; await updateDoc(ref, { locationId: finalLoc, isDisposed: false }); const locName = getLocationNamePlain(finalLoc); await logActivity('Item Moved', `Moved ${name} (${equipId}) to ${locName}`); } app.closeModal(); showToast('Item moved'); } catch(e) { console.error(e); showToast('Move failed', 'error'); } },

            submitAddLocation: async (e) => { 
                e.preventDefault(); 
                if (!isManager()) return showToast("Unauthorized", 'error');
                const form = e.target; try { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'locations'), { type: form.type.value, parentId: form.parentId.value || null, name: form.name.value, customId: form.customId ? form.customId.value : null, status: form.status ? form.status.value : null, createdAt: new Date().toISOString() }); await logActivity('Location Created', `Created ${form.type.value}: ${form.name.value}`); app.closeModal(); showToast('Location created'); } catch(e) { console.error(e); showToast('Error creating location', 'error'); } 
            },

            submitEditLocation: async (e, id) => { 
                e.preventDefault(); 
                if (!isManager()) return showToast("Unauthorized", 'error');
                const form = e.target; try { const updateData = { name: form.name.value }; if (form.customId) updateData.customId = form.customId.value; await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'locations', id), updateData); await logActivity('Location Updated', `Updated location: ${form.name.value}`); app.closeModal(); showToast('Location updated'); } catch(e) { console.error(e); showToast('Error updating location', 'error'); } 
            },

            deleteLocation: (id) => { 
                const doDelete = async () => { 
                    if (!isManager()) return showToast("Unauthorized", 'error');
                    try { const items = state.inventory.filter(i => i.locationId === id); const batch = writeBatch(db); items.forEach(i => { batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', i.id), { locationId: null }); }); batch.delete(doc(db, 'artifacts', appId, 'public', 'data', 'locations', id)); await batch.commit(); await logActivity('Location Deleted', `Deleted location ID: ${id}`); app.closeModal(); showToast('Location deleted'); } catch(e) { console.error(e); showToast('Delete failed', 'error'); } }; app.openConfirmModal("Delete this location? Items will be moved to Storage.", doDelete); 
            },

            submitAddItems: async (e, locationId) => { e.preventDefault(); const form = e.target; const checkboxes = form.querySelectorAll('input[name="selectedItems"]:checked'); if (checkboxes.length === 0) return; try { const batch = writeBatch(db); checkboxes.forEach(cb => { batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', cb.value), { locationId: locationId || null }); }); await batch.commit(); await logActivity('Items Moved', `Moved ${checkboxes.length} items to ${getLocationNamePlain(locationId)}`); app.closeModal(); showToast(`${checkboxes.length} items moved`); } catch(e) { console.error(e); showToast('Move failed', 'error'); } },

            submitManageCategory: async (e, action, oldName) => { 
                e.preventDefault(); 
                if (!isManager()) return showToast("Unauthorized", 'error');
                const newName = e.target.name.value.trim(); if(!newName) return; let cats = [...(state.masterData.categories || [])]; let logDetails = ''; if (action === 'add') { if(cats.some(c => c.name === newName)) return alert('Category exists'); cats.push({ name: newName, subs: [] }); logDetails = `Created category: ${newName}`; } else if (action === 'rename') { const idx = cats.findIndex(c => c.name === oldName); if(idx === -1) return; cats[idx].name = newName; const batch = writeBatch(db); const items = state.inventory.filter(i => i.category === oldName); items.forEach(i => { batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', i.id), { category: newName }); }); await batch.commit(); logDetails = `Renamed category '${oldName}' to '${newName}'`; } state.masterData.categories = cats; await saveMasterData(); if(logDetails) await logActivity('Settings Update', logDetails); app.closeModal(); showToast('Category updated'); 
            },

            submitManageSubCategory: async (e, action, parentCat, oldName) => { 
                e.preventDefault(); 
                if (!isManager()) return showToast("Unauthorized", 'error');
                const newName = e.target.name.value.trim(); if(!newName) return; let cats = [...(state.masterData.categories || [])]; const catIdx = cats.findIndex(c => c.name === parentCat); if(catIdx === -1) return; let subs = cats[catIdx].subs || []; let logDetails = ''; if(action === 'add') { if(subs.includes(newName)) return alert('Sub-category exists'); subs.push(newName); logDetails = `Added sub-category '${newName}' to '${parentCat}'`; } else if (action === 'rename') { const idx = subs.indexOf(oldName); if(idx === -1) return; subs[idx] = newName; const batch = writeBatch(db); const items = state.inventory.filter(i => i.category === parentCat && i.subCategory === oldName); items.forEach(i => { batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', i.id), { subCategory: newName }); }); await batch.commit(); logDetails = `Renamed sub-category '${oldName}' to '${newName}' in '${parentCat}'`; } cats[catIdx].subs = subs; state.masterData.categories = cats; await saveMasterData(); if(logDetails) await logActivity('Settings Update', logDetails); app.closeModal(); showToast('Sub-category updated'); 
            },

            submitMoveSubCategory: async (e, subName, currentParent) => { 
                e.preventDefault(); 
                if (!isManager()) return showToast("Unauthorized", 'error');
                const newParent = e.target.newParent.value; if(!newParent || newParent === currentParent) return; let cats = [...(state.masterData.categories || [])]; const oldCatIdx = cats.findIndex(c => c.name === currentParent); if(oldCatIdx !== -1) { cats[oldCatIdx].subs = cats[oldCatIdx].subs.filter(s => s !== subName); } const newCatIdx = cats.findIndex(c => c.name === newParent); if(newCatIdx !== -1) { if(!cats[newCatIdx].subs) cats[newCatIdx].subs = []; if(!cats[newCatIdx].subs.includes(subName)) cats[newCatIdx].subs.push(subName); } const batch = writeBatch(db); const items = state.inventory.filter(i => i.category === currentParent && i.subCategory === subName); items.forEach(i => { batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'inventory', i.id), { category: newParent }); }); await batch.commit(); state.masterData.categories = cats; await saveMasterData(); await logActivity('Settings Update', `Moved sub-category '${subName}' from '${currentParent}' to '${newParent}'`); app.closeModal(); showToast('Sub-category moved'); 
            },
            
            // --- FIXES HERE: Replacing confirm() with app.openConfirmModal() ---
            deleteMasterCategory: async (name) => { 
                const doDelete = async () => {
                    if (!isManager()) return showToast("Unauthorized", 'error');
                    let cats = (state.masterData.categories || []).filter(c => c.name !== name); 
                    state.masterData.categories = cats; 
                    await saveMasterData(); 
                    await logActivity('Settings Update', `Deleted category '${name}'`); 
                    showToast('Category deleted');
                };
                app.openConfirmModal(`Delete category "${name}"? Items will become Uncategorized.`, doDelete);
            },
            
            deleteMasterSubCategory: async (catName, subName) => { 
                const doDelete = async () => {
                    if (!isManager()) return showToast("Unauthorized", 'error');
                    let cats = [...(state.masterData.categories || [])]; 
                    const idx = cats.findIndex(c => c.name === catName); 
                    if(idx !== -1) { 
                        cats[idx].subs = cats[idx].subs.filter(s => s !== subName); 
                        state.masterData.categories = cats; 
                        await saveMasterData(); 
                        await logActivity('Settings Update', `Deleted sub-category '${subName}' from '${catName}'`); 
                        showToast('Sub-category deleted'); 
                    } 
                };
                app.openConfirmModal(`Delete sub-category "${subName}"?`, doDelete);
            },

            // --- PDF GENERATION ---
            generatePDF: () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const now = new Date();
                const dateStr = formatDatePH(now.toISOString());
                // Corporate Colors
                const darkBlue = [26, 54, 93]; 
                const slateGray = [100, 116, 139];
                const lightGray = [241, 245, 249];
                // --- HEADER ---
                doc.setFillColor(...darkBlue);
                doc.rect(0, 0, 210, 40, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(24);
                doc.setFont('helvetica', 'bold');
                doc.text("INVENTORY REPORT", 14, 25);
                doc.setFontSize(10);
                doc.setFont('helvetica', 'normal');
                doc.text(`Generated: ${dateStr}`, 14, 33);
                let yPos = 55;
                // --- SELECTIONS ---
                const includeSummary = document.getElementById('report-summary').checked;
                const includeInventory = document.getElementById('report-inventory').checked;
                const includeLocations = document.getElementById('report-locations').checked;
                const includeLogs = document.getElementById('report-logs').checked;
                // --- 1. EXECUTIVE SUMMARY ---
                if (includeSummary) {
                    doc.setTextColor(0, 0, 0);
                    doc.setFontSize(14);
                    doc.setFont('helvetica', 'bold');
                    doc.text("EXECUTIVE SUMMARY", 14, yPos);
                    doc.setDrawColor(...slateGray);
                    doc.line(14, yPos + 2, 196, yPos + 2);
                    yPos += 15;
                    // Metrics
                    const totalItems = state.inventory.filter(i => !i.isDisposed).length;
                    const assigned = state.inventory.filter(i => !i.isDisposed && i.locationId).length;
                    const storage = totalItems - assigned;
                    const disposed = state.inventory.filter(i => i.isDisposed).length;
                    const rooms = state.locations.filter(l => l.type === 'room');
                    const vacant = rooms.filter(r => r.status === 'vacant').length;
                    const occupied = rooms.filter(r => r.status === 'occupied').length;
                    const maintenance = rooms.filter(r => r.status === 'maintenance').length;
                    const subCounts = {};
                    state.inventory.filter(i => !i.isDisposed).forEach(i => {
                        const sub = i.subCategory || 'General';
                        subCounts[sub] = (subCounts[sub] || 0) + 1;
                    });
                    const topSubs = Object.entries(subCounts).sort((a,b) => b[1] - a[1]).slice(0, 5).map(([k,v]) => `${k}: ${v}`).join(', ');
                    const summaryData = [['Total Active Assets', totalItems, 'Vacant Rooms', vacant],['In Storage', storage, 'Occupied Rooms', occupied],['Assigned / Deployed', assigned, 'Under Maintenance', maintenance],['Disposed / Retired', disposed, 'Top Categories', topSubs]];
                    doc.autoTable({ startY: yPos, body: summaryData, theme: 'grid', styles: { fontSize: 9, cellPadding: 4, lineColor: [200, 200, 200] }, columnStyles: { 0: { fontStyle: 'bold', fillColor: lightGray, cellWidth: 40 }, 2: { fontStyle: 'bold', fillColor: lightGray, cellWidth: 40 } }, margin: { left: 14, right: 14 } });
                    yPos = doc.lastAutoTable.finalY + 20;
                }
                // --- 2. FULL INVENTORY (Grouped) ---
                if (includeInventory) {
                    if (yPos > 240) { doc.addPage(); yPos = 20; }
                    doc.setTextColor(0, 0, 0); doc.setFontSize(14); doc.setFont('helvetica', 'bold'); doc.text("FULL INVENTORY LIST", 14, yPos); doc.line(14, yPos + 2, 196, yPos + 2); yPos += 10;
                    const grouped = {};
                    state.inventory.filter(i => !i.isDisposed).forEach(i => { if(!grouped[i.category]) grouped[i.category] = {}; if(!grouped[i.category][i.subCategory]) grouped[i.category][i.subCategory] = []; grouped[i.category][i.subCategory].push(i); });
                    const tableRows = [];
                    Object.keys(grouped).sort().forEach(cat => {
                        tableRows.push([{ content: cat.toUpperCase(), colSpan: 5, styles: { fillColor: [226, 232, 240], fontStyle: 'bold', textColor: [0,0,0] } }]);
                        Object.keys(grouped[cat]).sort().forEach(sub => {
                            tableRows.push([{ content: `   ${sub}`, colSpan: 5, styles: { fillColor: [248, 250, 252], fontStyle: 'bold', textColor: [100,100,100] } }]);
                            const items = grouped[cat][sub].sort((a,b) => a.equipmentId.localeCompare(b.equipmentId, undefined, {numeric: true}));
                            items.forEach(item => { const locName = item.locationId ? getLocationNamePlain(item.locationId) : 'Storage'; tableRows.push([ item.equipmentId, item.name, locName, item.condition, item.quantity || 1 ]); });
                        });
                    });
                    doc.autoTable({ startY: yPos, head: [['ID', 'Item Name', 'Location', 'Condition', 'Qty']], body: tableRows, theme: 'plain', headStyles: { fillColor: darkBlue, textColor: 255 }, styles: { fontSize: 8, cellPadding: 2 }, columnStyles: { 0: { fontStyle: 'bold', cellWidth: 30 } }, margin: { left: 14, right: 14 } });
                    yPos = doc.lastAutoTable.finalY + 20;
                }
                // --- 3. LOCATION STATUS (Grouped by Floor & Sorted) ---
                if (includeLocations) {
                    if (yPos > 250) { doc.addPage(); yPos = 20; }
                    doc.setTextColor(0, 0, 0); doc.setFontSize(14); doc.setFont('helvetica', 'bold'); doc.text("LOCATION STATUS REPORT", 14, yPos); doc.line(14, yPos + 2, 196, yPos + 2); yPos += 10;
                    const floors = state.locations.filter(l => l.type === 'floor').sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric: true}));
                    const locRows = [];
                    floors.forEach(floor => {
                        locRows.push([{ content: floor.name.toUpperCase(), colSpan: 4, styles: { fillColor: [226, 232, 240], fontStyle: 'bold', textColor: [0,0,0] } }]);
                        const rooms = state.locations.filter(l => l.type === 'room' && l.parentId === floor.id).sort((a,b) => a.name.localeCompare(b.name, undefined, {numeric: true}));
                        if (rooms.length === 0) { locRows.push([{ content: 'No rooms configured.', colSpan: 4, styles: { fontStyle: 'italic', textColor: [150,150,150] } }]); }
                        rooms.forEach(l => { const roomItems = state.inventory.filter(i => i.locationId === l.id); const subCounts = {}; roomItems.forEach(i => { const sub = i.subCategory || 'General'; subCounts[sub] = (subCounts[sub] || 0) + 1; }); const assetDetails = Object.keys(subCounts).length > 0 ? Object.entries(subCounts).map(([k,v]) => `${k}: ${v}`).join(', ') : 'Empty'; locRows.push([ l.customId || 'N/A', l.name, l.status ? l.status.toUpperCase() : 'UNKNOWN', assetDetails ]); });
                    });
                    doc.autoTable({ startY: yPos, head: [['Room ID', 'Name', 'Status', 'Assets Breakdown']], body: locRows, theme: 'grid', headStyles: { fillColor: darkBlue, textColor: 255 }, styles: { fontSize: 9, cellPadding: 3, valign: 'middle' }, columnStyles: { 3: { fontSize: 8 } }, margin: { left: 14, right: 14 } });
                    yPos = doc.lastAutoTable.finalY + 20;
                }
                // --- 4. ACTIVITY LOGS ---
                if (includeLogs) {
                    doc.addPage(); yPos = 20; doc.setTextColor(0, 0, 0); doc.setFontSize(14); doc.setFont('helvetica', 'bold'); doc.text("SYSTEM ACTIVITY LOGS", 14, yPos); doc.line(14, yPos + 2, 196, yPos + 2); yPos += 10;
                    const logRows = state.logs.slice(0, 50).map(l => { return [formatDatePH(l.timestamp), l.action, l.details]; });
                    doc.autoTable({ startY: yPos, head: [['Timestamp', 'Action', 'Details']], body: logRows, theme: 'striped', headStyles: { fillColor: slateGray, textColor: 255 }, styles: { fontSize: 8, cellPadding: 2 }, columnStyles: { 0: { cellWidth: 40 }, 1: { fontStyle: 'bold', cellWidth: 40 } }, margin: { left: 14, right: 14 } });
                }
                // --- FOOTER (Page Numbers) ---
                const pageCount = doc.internal.getNumberOfPages(); for(let i = 1; i <= pageCount; i++) { doc.setPage(i); doc.setFontSize(8); doc.setTextColor(150); doc.text(`Page ${i} of ${pageCount}`, 196, 285, { align: 'right' }); }
                doc.save(`Equipment_Report_${now.toISOString().slice(0,10)}.pdf`);
                showToast("PDF Report Generated");
            }
        };

        // --- Render Helpers ---

        function updateNavUI() {
            // Added 'activity' to desktop nav list
            ['dashboard', 'storage', 'floors', 'boxes', 'activity', 'settings'].forEach(tab => {
                const btn = document.getElementById(`nav-${tab}`);
                if (btn) {
                    if (tab === state.activeTab) {
                        btn.classList.remove('nav-item-inactive', 'text-gray-500');
                        btn.classList.add('nav-item-active');
                    } else {
                        btn.classList.add('nav-item-inactive');
                        btn.classList.remove('nav-item-active');
                        // Restore special class for settings if needed
                        if(tab === 'settings') btn.classList.add('text-gray-500'); 
                    }
                }
            });
            // Update Mobile Nav - Added 'activity'
            ['dashboard', 'storage', 'floors', 'boxes', 'activity', 'settings'].forEach(tab => {
                const btn = document.getElementById(`mob-${tab}`);
                if (btn) {
                    if (tab === state.activeTab) {
                        btn.classList.remove('mobile-nav-inactive');
                        btn.classList.add('mobile-nav-active');
                    } else {
                        btn.classList.add('mobile-nav-inactive');
                        btn.classList.remove('mobile-nav-active');
                    }
                }
            });

            // RBAC: Hide Settings Navigation if not manager
            const sidebarSettings = document.getElementById('sidebar-settings-container');
            const mobSettings = document.getElementById('mob-settings');
            
            if (state.userRole && !isManager()) {
                if(sidebarSettings) sidebarSettings.classList.add('hidden');
                if(mobSettings) mobSettings.classList.add('hidden');
            } else {
                if(sidebarSettings) sidebarSettings.classList.remove('hidden');
                if(mobSettings) mobSettings.classList.remove('hidden');
            }
        }

        function renderStorageList() {
            const list = document.getElementById('inventory-list');
            if(list) {
                list.innerHTML = generateInventoryItems();
                lucide.createIcons();
            }
        }

        function renderMainContent() {
            const main = document.getElementById('main-content');
            const title = document.getElementById('header-title');
            
            if (state.loading) return;

            // RBAC Redirect if unauthorized access to settings
            if (state.activeTab === 'settings' && !isManager()) {
                app.setActiveTab('dashboard');
                showToast("Access Denied: Settings restricted", "error");
                return;
            }

            if (state.activeTab === 'dashboard') {
                title.innerText = "Dashboard";
                main.innerHTML = generateDashboardView();
            } else if (state.activeTab === 'storage') {
                title.innerText = "Storage Overview";
                main.innerHTML = generateStorageView();
            } else if (state.activeTab === 'floors') {
                title.innerText = "Floor Management";
                main.innerHTML = generateFloorsView(); 
            } else if (state.activeTab === 'boxes') {
                title.innerText = "Box Index";
                main.innerHTML = generateBoxesView();
            } else if (state.activeTab === 'activity') {
                title.innerText = "Activity Logs";
                main.innerHTML = generateActivityLogView();
            } else if (state.activeTab === 'settings') {
                title.innerText = "Settings";
                main.innerHTML = generateSettingsView();
            }
            lucide.createIcons();
        }
        
        // Add Close logic for dropdown when clicking outside
        window.onclick = function(event) {
            const dropdown = document.getElementById('user-menu-dropdown');
            const btn = document.getElementById('user-menu-btn');
            
            if (!dropdown || dropdown.classList.contains('hidden')) return;

            // If click is outside button and dropdown
            if (btn && !btn.contains(event.target) && !dropdown.contains(event.target)) {
                 dropdown.classList.add('hidden');
            }
        }

        // Initialization
        async function init() {
            onAuthStateChanged(auth, async (u) => {
                state.user = u;
                
                const authContainer = document.getElementById('auth-container');
                const sidebar = document.getElementById('app-sidebar');
                const mainApp = document.getElementById('app-main');
                const userDisplay = document.getElementById('header-user-name');
                const mobileUserDisplay = document.getElementById('header-user-name-mobile');
                const userRoleDisplay = document.getElementById('header-user-role');
                const mobileUserRoleDisplay = document.getElementById('header-user-role-mobile');

                if (u) {
                    // Fetch User Role
                    try {
                        const roleDoc = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', 'user_roles', u.uid));
                        if (roleDoc.exists()) {
                            state.userRole = roleDoc.data().role;
                            state.user.displayName = roleDoc.data().nickname || u.displayName; // Ensure nickname is fresh
                        } else {
                            // Fallback if no role doc exists (legacy users or direct firebase auth)
                            state.userRole = 'Live Operator'; 
                        }
                    } catch (e) {
                        console.error("Error fetching role:", e);
                        state.userRole = 'Live Operator';
                    }

                    // Logged In
                    authContainer.classList.add('hidden');
                    
                    // Fixed: Sidebar should be visible on desktop (md:flex) but hidden on mobile
                    sidebar.classList.add('hidden'); 
                    sidebar.classList.add('md:flex');
                    
                    mainApp.classList.remove('hidden');
                    const name = state.user.displayName || state.user.email || 'User';
                    
                    if(userDisplay) userDisplay.innerText = name;
                    if(mobileUserDisplay) mobileUserDisplay.innerText = name;
                    if(userRoleDisplay) userRoleDisplay.innerText = state.userRole;
                    if(mobileUserRoleDisplay) mobileUserRoleDisplay.innerText = state.userRole;
                    
                    startListeners();
                    updateNavUI(); // Ensure nav reflects RBAC
                } else {
                    // Logged Out
                    authContainer.classList.remove('hidden');
                    authContainer.innerHTML = generateAuthView();
                    sidebar.classList.add('hidden');
                    sidebar.classList.remove('md:flex');
                    mainApp.classList.add('hidden');
                    
                    state.loading = false;
                    state.inventory = [];
                    state.locations = [];
                    state.logs = [];
                    state.userRole = null;
                    lucide.createIcons();
                }
            });
            updateNavUI();
        }

        function startListeners() {
            state.loading = true;
            // Removed user ID check here since we want shared data, but auth gating
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'inventory'), (snap) => {
                state.inventory = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                checkLoading();
                app.refreshModal();
            });
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'locations'), (snap) => {
                state.locations = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                checkLoading();
                app.refreshModal();
            });
            // FIXED: Path matches saveMasterData
            onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'global_settings', 'masterData'), (docSnap) => {
                 if (docSnap.exists()) {
                     state.masterData = docSnap.data();
                 } else {
                     // Init master data from inventory if empty
                     if (state.inventory.length > 0 && (!state.masterData.categories || state.masterData.categories.length === 0)) {
                         const temp = {};
                         state.inventory.forEach(i => {
                             if (!temp[i.category]) temp[i.category] = new Set();
                             if (i.subCategory) temp[i.category].add(i.subCategory);
                         });
                         state.masterData.categories = Object.keys(temp).map(k => ({ name: k, subs: Array.from(temp[k]) }));
                         saveMasterData();
                     }
                 }
                 renderMainContent();
            });
            const logsQuery = query(collection(db, 'artifacts', appId, 'public', 'data', 'logs'), orderBy('timestamp', 'desc'), limit(50));
            onSnapshot(logsQuery, (snap) => {
                state.logs = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if(state.activeTab === 'activity') renderMainContent();
            });
        }

        let dataLoadedCount = 0;
        function checkLoading() {
            dataLoadedCount++;
            if (dataLoadedCount >= 1) { 
                state.loading = false;
                renderMainContent();
            }
        }

        // Initial launch
        init();
    </script>
</body>
</html>